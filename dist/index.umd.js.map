{"version":3,"file":"index.umd.js","sources":["../src/form-builder.js","../src/index.js"],"sourcesContent":["export default class FormBuilder {\n  constructor(controller) {\n    this.controller = controller;\n  }\n\n  get forms() {\n    return this.controller.formTargets;\n  }\n\n  get template() {\n    return this.forms.slice(-1)[0];\n  }\n\n  get tags() {\n    return this.controller.constructor.tags;\n  }\n\n  get attributes() {\n    return this.controller.constructor.attributes;\n  }\n\n  get assocs() {\n    return this.controller.assocs;\n  }\n\n  run() {\n    let form = this.clone(this.template);\n    form.style.display = '';\n\n    let newIndex = this.forms.length + this.controller.startValue;\n    this.renewIndex(form, newIndex);\n\n    return form;\n  }\n\n  clone(template) {\n    let clone = template.cloneNode(true);\n    this.clear(clone);\n    this.setRadio(clone);\n    this.removePK(clone);\n    return clone;\n  }\n\n  clear(clone) {\n    clone.querySelectorAll('textarea, input[type=text]').forEach(elem => elem.value = '');\n    clone.querySelectorAll('input[type=radio], input[type=checkbox]').forEach(elem => elem.checked = false);\n    clone.querySelectorAll('option').forEach(elem => elem.selected = false);\n    clone.querySelectorAll('input[name$=\"[_destroy]\"]').forEach(elem => elem.removeAttribute('value'));\n  }\n\n  setRadio(clone) {\n    let names = Array.from(clone.querySelectorAll('input[name][type=radio]')).map(radio => radio.name);\n    let nameSet = new Set(names);\n    nameSet.forEach(name => {\n      let radios = Array.from(clone.querySelectorAll(`input[type=radio][name=\"${name}\"]`));\n      if (radios.every(radio => radio.checked == false)) {\n        radios[0].checked = true;\n      }\n    });\n  }\n\n  removePK(form) {\n    let regexps = this.assocs.map(assoc => new RegExp(`${assoc.description}(\\\\])?\\\\[\\\\d+\\\\]\\\\[${assoc.pk}\\\\]$`));\n\n    form.querySelectorAll('input[name][type=hidden]').forEach(elem => {\n      regexps.forEach(regexp => {\n        if (elem.name.match(regexp)) {\n          elem.remove();\n        }\n      });\n    });\n  }\n\n  renewIndex(form, newIndex) {\n    let selector = this.tags.join(', ');\n    let regexps = this.assocs.map(assoc => new RegExp(`(${assoc.description}(\\\\[|\\\\]\\\\[|_)?)\\\\d+`));\n\n    form.querySelectorAll(selector).forEach(elem => {\n      this.attributes.forEach(attr => {\n        let value = elem.getAttribute(attr);\n        if (!value) return;\n        regexps.forEach(regexp => {\n          value = value.replace(regexp, '$1' + newIndex);\n        });\n        elem.setAttribute(attr, value);\n      });\n    });\n  }\n}\n","import { Controller } from '@hotwired/stimulus';\nimport FormBuilder from './form-builder';\n\nexport default class extends Controller {\n  static targets = ['form'];\n  static values = {\n    start: { type: Number, default: 0 },\n    increment: { type: Number, default: 1 },\n    max: Number,\n    addPos: { type: String, default: 'last' },\n    associations: { type: Array, default: [''] },\n    suffixes: { type: Array, default: ['_attributes'] },\n    primaryKeys: { type: Array, default: ['id'] },\n  };\n\n  static tags = ['input', 'textarea', 'select', 'label'];\n  static attributes = ['id', 'name', 'for'];\n\n  get adder() {\n    return this.scope.findElement(`[data-action=\"${this.identifier}#add\"]`);\n  }\n\n  get assocs() {\n    let associations = [].concat(this.associationsValue);\n    let suffixes = [].concat(this.suffixesValue);\n    let primaryKeys = [].concat(this.primaryKeysValue);\n    return associations.map((assoc, i) => {\n      let suffix = suffixes[i] || suffixes[0];\n      let pk = primaryKeys[i] || primaryKeys[0];\n      return { description: `${assoc}${suffix}`, pk: pk };\n    });\n  }\n\n  initialize() {\n    this.builder = new FormBuilder(this);\n  }\n\n  add(e) {\n    for (let n=0; n<this.incrementValue; n++) {\n      let form = this.builder.run();\n\n      let event = this.dispatch('before-add', { detail: { form: form }});\n      if (event.defaultPrevented) continue;\n      this.addForm(form);\n      this.dispatch('after-add', { detail: { form: form }});\n\n      if (this.hasMaxForms()) break;\n    }\n\n    e.preventDefault();\n  }\n\n  remove(e) {\n    let form = e.target.closest(`[data-${this.identifier}-target=\"form\"]`);\n    if (!form) return;\n\n    let event = this.dispatch('before-remove', { detail: { form: form }});\n    if (event.defaultPrevented) return;\n    this.removeForm(form);\n    this.dispatch('after-remove', { detail: { form: form }});\n\n    e.preventDefault();\n  }\n\n  addForm(form) {\n    if (this.addPosValue == 'first') {\n      this.formTargets[0].before(form);\n    } else {\n      this.formTargets.slice(-1)[0].after(form);\n    }\n\n    setTimeout(() => {\n      form.querySelectorAll(`[data-controller=\"${this.identifier}\"]`).forEach(nestedForm => {\n        let controller = this.application.getControllerForElementAndIdentifier(nestedForm, this.identifier);\n        if (controller) {\n          controller.formTargets.forEach(form => controller.builder.removePK(form));\n        }\n      });\n    });\n\n    this.refresh();\n  }\n\n  removeForm(form) {\n    form.style.display = 'none';\n\n    let regexps = this.assocs.map(assoc => new RegExp(`${assoc.description}(\\\\])?\\\\[\\\\d+\\\\]\\\\[_destroy\\\\]`));\n    let destroyFound = false;\n\n    form.querySelectorAll('input[name][type=hidden]').forEach(elem => {\n      regexps.forEach(regexp => {\n        if (elem.name.match(regexp)) {\n          elem.value = '1';\n          destroyFound = true;\n        }\n      });\n    });\n\n    if (!destroyFound) {\n      // Remove element from DOM to clean out the association\n      form.remove();\n    }\n\n    this.refresh();\n  }\n\n  refresh() {\n    if (this.hasMaxForms()) {\n      this.toggleAdder(false);\n    } else {\n      this.toggleAdder(true);\n    }\n  }\n\n  hasMaxForms() {\n    return this.maxValue &&\n           this.formTargets.filter(form => form.style.display != 'none').length >= this.maxValue;\n  }\n\n  toggleAdder(enabled) {\n    if (this.adder) this.adder.disabled = !enabled;\n  }\n}\n"],"names":["FormBuilder","constructor","controller","this","forms","formTargets","template","slice","tags","attributes","assocs","run","form","clone","style","display","renewIndex","length","startValue","cloneNode","clear","setRadio","removePK","querySelectorAll","forEach","elem","value","checked","selected","removeAttribute","names","Array","from","map","radio","name","Set","radios","every","regexps","assoc","RegExp","description","pk","regexp","match","remove","newIndex","selector","join","attr","getAttribute","replace","setAttribute","_Class","Controller","adder","scope","findElement","identifier","associations","concat","associationsValue","suffixes","suffixesValue","primaryKeys","primaryKeysValue","i","initialize","builder","add","e","n","incrementValue","dispatch","detail","defaultPrevented","addForm","hasMaxForms","preventDefault","target","closest","removeForm","addPosValue","before","after","setTimeout","nestedForm","application","getControllerForElementAndIdentifier","refresh","destroyFound","toggleAdder","maxValue","filter","enabled","disabled","targets","values","start","type","Number","default","increment","max","addPos","String"],"mappings":"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"}