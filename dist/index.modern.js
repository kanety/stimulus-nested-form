import{Controller as e}from"@hotwired/stimulus";class t{constructor(e){this.controller=e}get forms(){return this.controller.formTargets}get template(){return this.forms.slice(-1)[0]}get tags(){return this.controller.constructor.tags}get attributes(){return this.controller.constructor.attributes}get assocs(){return this.controller.assocs}run(){let e=this.clone(this.template);return e.style.display="",this.renewIndex(e,this.forms.length+this.controller.startValue),e}clone(e){let t=e.cloneNode(!0);return this.clear(t),this.setRadio(t),this.removePK(t),t}clear(e){e.querySelectorAll("textarea, input[type=text]").forEach(e=>e.value=""),e.querySelectorAll("input[type=radio], input[type=checkbox]").forEach(e=>e.checked=!1),e.querySelectorAll("option").forEach(e=>e.selected=!1),e.querySelectorAll('input[name$="[_destroy]"]').forEach(e=>e.removeAttribute("value"))}setRadio(e){let t=Array.from(e.querySelectorAll("input[name][type=radio]")).map(e=>e.name);new Set(t).forEach(t=>{let r=Array.from(e.querySelectorAll(`input[type=radio][name="${t}"]`));r.every(e=>0==e.checked)&&(r[0].checked=!0)})}removePK(e){let t=this.assocs.map(e=>new RegExp(`${e.description}(\\])?\\[\\d+\\]\\[${e.pk}\\]$`));e.querySelectorAll("input[name][type=hidden]").forEach(e=>{t.forEach(t=>{e.name.match(t)&&e.remove()})})}renewIndex(e,t){let r=this.tags.join(", "),a=this.assocs.map(e=>new RegExp(`(${e.description}(\\[|\\]\\[|_)?)\\d+`));e.querySelectorAll(r).forEach(e=>{this.attributes.forEach(r=>{let s=e.getAttribute(r);s&&(a.forEach(e=>{s=s.replace(e,"$1"+t)}),e.setAttribute(r,s))})})}}class r extends e{get adder(){return this.scope.findElement(`[data-action="${this.identifier}#add"]`)}get assocs(){let e=[].concat(this.associationsValue),t=[].concat(this.suffixesValue),r=[].concat(this.primaryKeysValue);return e.map((e,a)=>({description:`${e}${t[a]||t[0]}`,pk:r[a]||r[0]}))}initialize(){this.builder=new t(this)}add(e){for(let e=0;e<this.incrementValue;e++){let e=this.builder.run();if(!this.dispatch("before-add",{detail:{form:e}}).defaultPrevented&&(this.addForm(e),this.dispatch("after-add",{detail:{form:e}}),this.hasMaxForms()))break}e.preventDefault()}remove(e){let t=e.target.closest(`[data-${this.identifier}-target="form"]`);t&&(this.dispatch("before-remove",{detail:{form:t}}).defaultPrevented||(this.removeForm(t),this.dispatch("after-remove",{detail:{form:t}}),e.preventDefault()))}addForm(e){"first"==this.addPosValue?this.formTargets[0].before(e):this.formTargets.slice(-1)[0].after(e),setTimeout(()=>{e.querySelectorAll(`[data-controller="${this.identifier}"]`).forEach(e=>{let t=this.application.getControllerForElementAndIdentifier(e,this.identifier);t&&t.formTargets.forEach(e=>t.builder.removePK(e))})}),this.refresh()}removeForm(e){e.style.display="none";let t=this.assocs.map(e=>new RegExp(`${e.description}(\\])?\\[\\d+\\]\\[_destroy\\]`));e.querySelectorAll("input[name][type=hidden]").forEach(e=>{t.forEach(t=>{e.name.match(t)&&(e.value="1")})}),this.refresh()}refresh(){this.hasMaxForms()?this.toggleAdder(!1):this.toggleAdder(!0)}hasMaxForms(){return this.maxValue&&this.formTargets.filter(e=>"none"!=e.style.display).length>=this.maxValue}toggleAdder(e){this.adder&&(this.adder.disabled=!e)}}r.targets=["form"],r.values={start:{type:Number,default:0},increment:{type:Number,default:1},max:Number,addPos:{type:String,default:"last"},associations:{type:Array,default:[""]},suffixes:{type:Array,default:["_attributes"]},primaryKeys:{type:Array,default:["id"]}},r.tags=["input","textarea","select","label"],r.attributes=["id","name","for"];export{r as default};
//# sourceMappingURL=index.modern.js.map
